<!doctype html>
<html>
    <head>
        <title>
            Alarm
        </title>
        <script src="https://epicenterprograms.github.io/standards/behavior/general.js"></script>
		<!--
        <script src="file:///C:/Users/Robert/Documents/GitHub/standards/behavior/general.js"></script>
		-->
        <script>
			var S = Standards.general;
            var countDown;
            var time;
            var colorChange;
            var colorNumber = 0;
			var sounds;
			var nagger;
            var timerTone,
                interval1,
                interval2,
				interval3,
				interval4,
				interval5;
            function changeBackground(speed) {
                var increment,
                    repeat;
                if (speed.toLowerCase() == "slow") {
                    increment = .1;
                    repeat = 500;
                } else if (speed.toLowerCase() == "fast") {
                    increment = .8;
                    repeat = 8;
                }
                if (colorChange) {
                    clearInterval(colorChange);
                }
                colorChange = setInterval(function() {
                    if (colorNumber > 100) {
                        colorNumber = 0;
                    }
                    var newColor = S.colorCode(null, colorNumber, [0,0,255], [255,0,255], [255,0,0], [255,255,0], [0,255,0], [0,255,255], [0,0,255]);
                    document.body.style.backgroundImage = "repeating-linear-gradient({0}, white 100vh, {0} 200vh)".format(newColor);
                    // The gradient is basically an image.
                    colorNumber += increment;
                }, repeat);
            }
            function impede(callback, tryNumber) {
                if (time < 0) {
                    var remark = "",
                        number1 = Math.round(Math.random()*10),
                        number2 = Math.round(Math.random()*10),
                        number3 = Math.round(Math.random()*10),
                        number4 = Math.round(Math.random()*10),
                        number5 = Math.round(Math.random()*100);
                    tryNumber = tryNumber===undefined ? 0 : tryNumber;
                    if (tryNumber > 0) {
                        remark = "WRONG!\nStart over!\n";
                    } else {  // makes sure at least some noise is playing
                        sounds[3].start();
                    }
                    if (prompt("{0}What is {1}×{2}+{3}×{4}?\n(What? You wanted to stop the noise?)".format(remark,number1,number2,number3,number4), number5) == number1 * number2 + number3 * number4) {
                        changeBackground("slow");
                        sounds.forEach(function(sound) {
                            sound.stop();
                        });
                        callback();
                    } else {
                        tryNumber++;
                        impede(callback, tryNumber);
                    }
                } else {
                    changeBackground("slow");
                    sounds.forEach(function(sound) {
                        sound.stop();
                    });
                    callback();
                }
            }
            S.listen("timer", "click", function() {
                if (this.innerHTML.trim() == "Start eye-strain timer") {
                    this.innerHTML = "Stop eye-strain timer";
                    interval1 = setInterval(function() {
                        timerTone.play("ae5a5");
						interval2 = setTimeout(function() {
							timerTone.play("a5e5a");
						}, 22000);
                    }, 1224000);
                } else {
                    this.innerHTML = "Start eye-strain timer";
                    clearInterval(interval2);
                    clearInterval(interval1);
                }
			});
			S.listen("distractionButton", "click", function () {
				let initialTime;
				let timeToDoStuff;
				let lifeCoach = new S.Speaker();
				if (this.textContent.trim() == "I'm distracted") {
					if (S.getId("distractionTime").value.trim() && S.getId("distractionTime").value.trim().search(/^\d+:\d+$/) > -1) {
						this.textContent = "I'm back on track";
						initialTime = new Date();
						let time = S.getId("distractionTime").value.trim();
						time = { hours: Number(time.split(":")[0]), minutes: Number(time.split(":")[1]), nextDay: false };
						if (initialTime.getHours() > 12) {
							if (initialTime.getHours() - 12 <= time.hours) {
								if (time.hours == 12) {  // if the time is during the midnight hour
									time.hours = 0;
								} else {
									time.hours += 12;
								}
							} else {
								nextDay = true;
							}
						} else if (initialTime.getHours() > time.hours) {
							time.hours += 12;
						}
						if (time.nextDay) {  // if the time goes into the next day
							timeToDoStuff = new Date(initialTime.getTime() + 86400000);
							timeToDoStuff = new Date(timeToDoStuff.getFullYear(), timeToDoStuff.getMonth(), timeToDoStuff.getDate(), time.hours, time.minutes);
						} else {
							timeToDoStuff = new Date(initialTime.getFullYear(), initialTime.getMonth(), initialTime.getDate(), time.hours, time.minutes);
						}
						function nag(time) {
							if (time < 5000) {
								time = 5000;
							}
							nagger = setTimeout(function () {
								lifeCoach.speak("Hey, you need to quit being distracted.");
								nag(time / 2);
							}, time);
						}
						nag((timeToDoStuff.getTime() - initialTime.getTime()) / 2);
					} else {
						S.makeDialog("You need to provide a time for when you need to be back on track.");
					}
				} else {
					this.textContent = "I'm distracted";
					S.getId("distractionTime").value = "";
					clearTimeout(nagger);
				}
			});
			S.listen("fiveMinutes", "click", function() {
				if (this.checked) {
					interval3 = setInterval(function() {
						timerTone.play("a5sa4");
					}, 300000);
				} else {
					clearInterval(interval3);
				}
			});
			S.listen("oneMinute", "click", function() {
				if (this.checked) {
					interval4 = setInterval(function() {
						timerTone.play("a4-");
					}, 60000);
				} else {
					clearInterval(interval4);
				}
			});
			S.listen("customRecurrence", "click", function() {
				if (this.checked) {
					let recurrence = S.getId("customNumber").value || 10;
					interval5 = setInterval(function() {
						timerTone.play("e5sa6");
					}, recurrence*60000);
				} else {
					clearInterval(interval5);
				}
			});
			S.listen("soundVolume", "change", function () {
				let volume = Number(this.value) / 100;
				sounds.forEach(function (sound) {
					sound.change("maxVolume", volume);
				});
				timerTone.change("maxVolume", volume);
				sounds[0].play("e5---");
			});
			S.onLoad(function () {
				S.makeToneGenerator(true, function () {
					sounds = [
						new S.Sound({ "waveform": "square" }),
						new S.Sound({ "waveform": "sawtooth", "frequency": 400 }),
						new S.Sound({ "waveform": "sawtooth", "frequency": 420 }),
						new S.Sound({ "waveform": "square", "changeWave": "sawtooth", "modulation": .5, "hertzChange": 150 }),
						new S.Sound({ "waveform": "square", "changeWave": "square", "modulation": 2, "hertzChange": 100 })
					];
					timerTone = new S.Sound();
				}, function () {
					S.makeDialog("Dude, don't you even understand the whole point of this webpage?", ["Yes", function () {
						S.makeDialog("You're insane. If you decide to be sensible, you can refresh the page.");
					}], ["No", function () {
						S.makeDialog("Would you like to learn?", ["Yes", function () {
							S.makeDialog("This is a webpage which uses various tones to do things such as keep you awake, reduce your eye-strain, and/or alert you to how much time has passed. Preventing the production of tones pretty much defeats the purpose of this page. If you'd like to change your mind, you can refresh the page to get another chance to go though this.");
						}], ["No", function () {
							S.makeDialog("Get out.", ["Okay", function () {
								window.open("", "_self").close();
							}]);
						}]);
					}]);
				});
                S.getId("start").addEventListener("click", function() {
                    if (this.innerHTML.trim() == "Start") {
                        this.innerHTML = "Renew";
                        S.getId("time").style.display = "none";
                        S.getId("time").value = S.getId("time").value.trim() ? Number(S.getId("time").value.trim())*60 : 400;
                        time = Number(S.getId("time").value);
                        S.getTag("h2")[0].innerHTML = "Seconds left: " + time;
                        document.title = "Alarm-time: " + time;
                        countDown = setInterval(function() {
                            if (time > 0 ) {
                                time--;
                                S.getTag("h2")[0].innerHTML = "Seconds left: " + time;
                                document.title = "Alarm-time: " + time;
                                if (time == 10) {
                                    // warning tone
                                    sounds[0].play("a4 a4 a4", {"attack":10, "noteLength":100, "decay":10});
                                }
                            } else {
                                sounds[1].start();
                                sounds[2].start();
                                setTimeout(function() {
                                    sounds[1].stop();
                                    sounds[2].stop();
                                }, 500);
                                if (time == 0) {
                                    changeBackground("fast");
                                }
                                if (time < -8 && !sounds[3].playing) {
                                    sounds[3].start();
                                }
                                if (time < -16 && !sounds[4].playing) {
                                    sounds[4].start();
                                }
                                time--;
                            }
                        }, 1000);
                    } else {
                        impede(function() {
                            time = Number(S.getId("time").value);
                            S.getTag("h2")[0].innerHTML = "Seconds left: " + time;
                            document.title = "Alarm-time: " + time;
                        });
                    }
                });
                S.getId("stop").addEventListener("click", function() {
					if (time < 0) {
						impede(function () {
							clearInterval(countDown);
							document.title = "Alarm";
							S.getTag("h2")[0].innerHTML = "Seconds left: &infin;";
							S.getId("time").value = "";
							S.getId("time").style.display = "inline-block";
							S.getId("start").innerHTML = "Start";
						});
					} else {
						S.makeDialog("Are you sure you want to stop the alarm?",
							["Yes", function () {
								clearInterval(countDown);
								changeBackground("slow");
								sounds.forEach(function (sound) {
									sound.stop();
								});
								document.title = "Alarm";
								S.getTag("h2")[0].innerHTML = "Seconds left: &infin;";
								S.getId("time").value = "";
								S.getId("time").style.display = "inline-block";
								S.getId("start").innerHTML = "Start";
							}],
							"No"
						);
                    }
                });
                S.getId("timer").click();
                changeBackground("slow");
            });
        </script>
        <link rel="stylesheet" href="https://epicenterprograms.github.io/standards/formatting/foundation.css">
		<!--
        <link rel="stylesheet" href="file:///C:/Users/Robert/Documents/GitHub/standards/formatting/foundation.css">
		-->
		<style>
			#distractionTime {
				width: 3em;
			}
			#customNumber {
				width: 2em;
			}
		</style>
    </head>
    <body>
        <h1 class="main-title">
            Alarm
        </h1>
        <main>
            <h2>
                Seconds left: &infin;
            </h2>
            <input type="text" id="time" placeholder="Time to recur (minutes)">
            <br>
            <br>
            <button id="start">
                Start
            </button>
            <button id="stop">
                Stop
            </button>
            <br>
            <br>
            <button id="timer">
                Start eye-strain timer
            </button>
			<br>
			<br>
			<button id="distractionButton">
				I'm distracted
			</button>
			I need to do something at
			<input type="text" id="distractionTime" placeholder="Time">
			<h4>
				Volume
			</h4>
			<input type="range" id="soundVolume" value="100">
			<br>
			<br>
			<div class="list">
				<input type="checkbox" id="fiveMinutes">
				<label for="fiveMinutes">Make a tone every 5 minutes</label>
				<br>
				<input type="checkbox" id="oneMinute">
				<label for="oneMinute">Make a tone every 1 minute</label>
				<br>
				<input type="checkbox" id="customRecurrence">
				<label for="customRecurrence">Make a tone every <input type="text" id="customNumber"> minutes</label>
			</div>
        </main>
    </body>
</html>
