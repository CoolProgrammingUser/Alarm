<!doctype html>
<html>
    <head>
        <title>
            Alarm
        </title>
        <script src="https://epicenterprograms.github.io/standards/behavior/general.js"></script>
		<!--
        <script src="file:///C:/Users/Robert/Documents/GitHub/standards/behavior/general.js"></script>
		-->
        <script>
			var S = Standards.general;
            var countDown;
            var time;
            var colorChange;
            var colorNumber = 0;
            var sounds = [
                new S.Sound({"waveform":"square"}),
                new S.Sound({"waveform":"sawtooth", "frequency":400}),
                new S.Sound({"waveform":"sawtooth", "frequency":420}),
                new S.Sound({"waveform":"square", "changeWave":"sawtooth", "modulation":.5, "hertzChange":150}),
                new S.Sound({"waveform":"square", "changeWave":"square", "modulation":2, "hertzChange":100})
                ];
            var timerTone = new S.Sound(),
                interval1,
                interval2,
				interval3,
				interval4,
				interval5;
            function changeBackground(speed) {
                var increment,
                    repeat;
                if (speed.toLowerCase() == "slow") {
                    increment = .1;
                    repeat = 500;
                } else if (speed.toLowerCase() == "fast") {
                    increment = .8;
                    repeat = 8;
                }
                if (colorChange) {
                    clearInterval(colorChange);
                }
                colorChange = setInterval(function() {
                    if (colorNumber > 100) {
                        colorNumber = 0;
                    }
                    var newColor = S.colorCode(null, colorNumber, [0,0,255], [255,0,255], [255,0,0], [255,255,0], [0,255,0], [0,255,255], [0,0,255]);
                    document.body.style.backgroundImage = "repeating-linear-gradient({0}, white 100vh, {0} 200vh)".format(newColor);
                    // The gradient is basically an image.
                    colorNumber += increment;
                }, repeat);
            }
            function impede(callback, tryNumber) {
                if (time < 0) {
                    var remark = "",
                        number1 = Math.round(Math.random()*10),
                        number2 = Math.round(Math.random()*10),
                        number3 = Math.round(Math.random()*10),
                        number4 = Math.round(Math.random()*10),
                        number5 = Math.round(Math.random()*100);
                    tryNumber = tryNumber===undefined ? 0 : tryNumber;
                    if (tryNumber > 0) {
                        remark = "WRONG!\nStart over!\n";
                    } else {  // makes sure at least some noise is playing
                        sounds[3].start();
                    }
                    if (prompt("{0}What is {1}×{2}+{3}×{4}?\n(What? You wanted to stop the noise?)".format(remark,number1,number2,number3,number4), number5) == number1 * number2 + number3 * number4) {
                        changeBackground("slow");
                        sounds.forEach(function(sound) {
                            sound.stop();
                        });
                        callback();
                    } else {
                        tryNumber++;
                        impede(callback, tryNumber);
                    }
                } else {
                    changeBackground("slow");
                    sounds.forEach(function(sound) {
                        sound.stop();
                    });
                    callback();
                }
            }
            S.listen("timer", "click", function() {
                if (this.innerHTML.trim() == "Start timer") {
                    this.innerHTML = "Stop timer";
                    interval1 = setInterval(function() {
                        timerTone.play("ae5a5");
						interval2 = setTimeout(function() {
							timerTone.play("a5e5a");
						}, 22000);
                    }, 1224000);
                } else {
                    this.innerHTML = "Start timer";
                    clearInterval(interval2);
                    clearInterval(interval1);
                }
            });
			S.listen("fiveMinutes", "click", function() {
				if (this.checked) {
					interval3 = setInterval(function() {
						timerTone.play("a5sa4");
					}, 300000);
				} else {
					clearInterval(interval3);
				}
			});
			S.listen("oneMinute", "click", function() {
				if (this.checked) {
					interval4 = setInterval(function() {
						timerTone.play("a4-");
					}, 60000);
				} else {
					clearInterval(interval4);
				}
			});
			S.listen("customRecurrence", "click", function() {
				if (this.checked) {
					let recurrence = S.getId("customNumber").value || 10;
					interval5 = setInterval(function() {
						timerTone.play("e5sa6");
					}, recurrence*60000);
				} else {
					clearInterval(interval5);
				}
			});
			S.listen("soundVolume", "change", function () {
				if (this.value === undefined) {
					var volume = 100;
				} else if (S.getType(Number(this.value)) == "Number") {
					var volume = Number(this.value);
				}
				if (typeof volume !== "undefined") {
					volume = volume / 100;
					sounds.forEach(function (sound) {
						sound.change("maxVolume", volume);
					});
				}
			});
            S.onLoad(function() {
                S.getId("start").addEventListener("click", function() {
                    if (this.innerHTML.trim() == "Start") {
                        this.innerHTML = "Renew";
                        S.getId("time").style.display = "none";
                        S.getId("time").value = S.getId("time").value.trim() ? Number(S.getId("time").value.trim())*60 : 400;
                        time = Number(S.getId("time").value);
                        S.getTag("h2")[0].innerHTML = "Seconds left: " + time;
                        document.title = "Alarm-time: " + time;
                        countDown = setInterval(function() {
                            if (time > 0 ) {
                                time--;
                                S.getTag("h2")[0].innerHTML = "Seconds left: " + time;
                                document.title = "Alarm-time: " + time;
                                if (time == 10) {
                                    // warning tone
                                    sounds[0].play("a4 a4 a4", {"attack":10, "noteLength":100, "decay":10});
                                }
                            } else {
                                sounds[1].start();
                                sounds[2].start();
                                setTimeout(function() {
                                    sounds[1].stop();
                                    sounds[2].stop();
                                }, 500);
                                if (time == 0) {
                                    changeBackground("fast");
                                }
                                if (time < -8 && !sounds[3].playing) {
                                    sounds[3].start();
                                }
                                if (time < -16 && !sounds[4].playing) {
                                    sounds[4].start();
                                }
                                time--;
                            }
                        }, 1000);
                    } else {
                        impede(function() {
                            time = Number(S.getId("time").value);
                            S.getTag("h2")[0].innerHTML = "Seconds left: " + time;
                            document.title = "Alarm-time: " + time;
                        });
                    }
                });
                S.getId("stop").addEventListener("click", function() {
					if (time < 0) {
						impede(function () {
							clearInterval(countDown);
							document.title = "Alarm";
							S.getTag("h2")[0].innerHTML = "Seconds left: &infin;";
							S.getId("time").value = "";
							S.getId("time").style.display = "inline-block";
							S.getId("start").innerHTML = "Start";
						});
					} else {
						S.makeDialog("Are you sure you want to stop the alarm?",
							["Yes", function () {
								clearInterval(countDown);
								changeBackground("slow");
								sounds.forEach(function (sound) {
									sound.stop();
								});
								document.title = "Alarm";
								S.getTag("h2")[0].innerHTML = "Seconds left: &infin;";
								S.getId("time").value = "";
								S.getId("time").style.display = "inline-block";
								S.getId("start").innerHTML = "Start";
							}],
							"No"
						);
                    }
                });
                S.getId("timer").click();
                changeBackground("slow");
            });
        </script>
        <link rel="stylesheet" href="https://epicenterprograms.github.io/standards/formatting/foundation.css">
		<!--
        <link rel="stylesheet" href="file:///C:/Users/Robert/Documents/GitHub/standards/formatting/foundation.css">
		-->
		<style>
			#customNumber {
				width: 2em;
			}
		</style>
    </head>
    <body>
        <h1 class="main-title">
            Alarm
        </h1>
        <main>
            <h2>
                Seconds left: &infin;
            </h2>
            <input type="text" id="time" placeholder="Time to recur (minutes)">
            <br>
            <br>
            <button id="start">
                Start
            </button>
            <button id="stop">
                Stop
            </button>
            <br>
            <br>
            <button id="timer">
                Start timer
            </button>
			<br>
			<br>
			<input type="text" id="soundVolume" placeholder="Volume (1-100)">
			<br>
			<br>
			<div class="list">
				<input type="checkbox" id="fiveMinutes">
				<label for="fiveMinutes">Make a tone every 5 minutes</label>
				<br>
				<input type="checkbox" id="oneMinute">
				<label for="oneMinute">Make a tone every 1 minute</label>
				<br>
				<input type="checkbox" id="customRecurrence">
				<label for="customRecurrence">Make a tone every <input type="text" id="customNumber"> minutes</label>
			</div>
        </main>
    </body>
</html>
