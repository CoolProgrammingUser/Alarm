<!DOCTYPE html>
<html class="html-class">
    <head>
        <title>
            Alarm
        </title>
        <script>
            var Standards = {};
            Standards.options = {"simplification" : true};
        </script>
        <script src="https://coolprogramminguser.github.io/Standards/behavior.js"></script>
        <script>
            var countDown;
            var time;
            var colorChange;
            var colorNumber = 0;
            var sounds = [
                new S.Sound({"waveform":"square"}),
                new S.Sound({"waveform":"sawtooth", "frequency":400}),
                new S.Sound({"waveform":"sawtooth", "frequency":420}),
                new S.Sound({"waveform":"square", "changeWave":"sawtooth", "modulation":.5, "hertzChange":150}),
                new S.Sound({"waveform":"square", "changeWave":"square", "modulation":2, "hertzChange":100})
                ];
            function changeBackground(speed) {
                var increment,
                    repeat;
                if (speed.toLowerCase() == "slow") {
                    increment = .1;
                    repeat = 500;
                } else if (speed.toLowerCase() == "fast") {
                    increment = .8;
                    repeat = 8;
                }
                if (colorChange) {
                    clearInterval(colorChange);
                }
                colorChange = setInterval(function() {
                    if (colorNumber > 100) {
                        colorNumber = 0;
                    }
                    var newColor = S.colorCode(null, colorNumber, [0,0,255], [255,0,0], [0,255,0], [0,0,255]);
                    document.body.style.backgroundImage = "repeating-linear-gradient({0}, white 100vh, {0} 200vh)".format(newColor);
                    // The gradient is basically an image.
                    colorNumber += increment;
                }, repeat);
            }
            function impede(callback, tryNumber) {
                if (time < 0) {
                    var remark = "",
                        number1 = Math.round(Math.random()*10),
                        number2 = Math.round(Math.random()*10),
                        number3 = Math.round(Math.random()*10),
                        number4 = Math.round(Math.random()*10),
                        number5 = Math.round(Math.random()*100);
                    tryNumber = tryNumber || 0;
                    if (tryNumber > 0) {
                        remark = "WRONG!\nStart over!\n";
                    } else {  // makes sure at least some noise is playing
                        sounds[3].start();
                    }
                    if (prompt("{0}What is {1}×{2}+{3}×{4}?\n(What? You wanted to stop the noise?)".format(remark,number1,number2,number3,number4), number5) == number1 * number2 + number3 * number4) {
                        changeBackground("slow");
                        sounds.forEach(function(sound) {
                            sound.stop();
                        });
                        callback();
                    } else {
                        tryNumber++;
                        impede(callback, tryNumber);
                    }
                } else {
                    changeBackground("slow");
                    sounds.forEach(function(sound) {
                        sound.stop();
                    });
                    callback();
                }
            }
            window.addEventListener("finished", function() {
                S.getId("start").addEventListener("click", function() {
                    if (this.innerHTML.trim() == "Start") {
                        this.innerHTML = "Renew";
                        S.getId("time").style.display = "none";
                        S.getId("time").value = S.getId("time").value.trim() ? Number(S.getId("time").value.trim())*60 : 900;
                        time = Number(S.getId("time").value);
                        S.getTag("h2")[0].innerHTML = "Seconds left: " + time;
                        document.title = "Alarm-time: " + time;
                        countDown = setInterval(function() {
                            if (time > 0 ) {
                                time--;
                                S.getTag("h2")[0].innerHTML = "Seconds left: " + time;
                                document.title = "Alarm-time: " + time;
                                if (time == 10) {
                                    // warning tone
                                    sounds[0].play("a4 a4 a4", {"attack":10, "noteLength":100, "decay":10});
                                }
                            } else {
                                sounds[1].start();
                                sounds[2].start();
                                setTimeout(function() {
                                    sounds[1].stop();
                                    sounds[2].stop();
                                }, 500);
                                if (time == 0) {
                                    changeBackground("fast");
                                }
                                if (time < -8 && !sounds[3].playing) {
                                    sounds[3].start();
                                }
                                if (time < -16 && !sounds[4].playing) {
                                    sounds[4].start();
                                }
                                time--;
                            }
                        }, 1000);
                    } else {
                        impede(function() {
                            time = Number(S.getId("time").value);
                            S.getTag("h2")[0].innerHTML = "Seconds left: " + time;
                            document.title = "Alarm-time: " + time;
                        });
                    }
                });
                S.getId("stop").addEventListener("click", function() {
                    if (time < 0) {
                        impede(function() {
                            clearInterval(countDown);
                            document.title = "Alarm";
                            S.getTag("h2")[0].innerHTML = "Seconds left: &infin;";
                            S.getId("time").value = "";
                            S.getId("time").style.display = "inline-block";
                            S.getId("start").innerHTML = "Start";
                        });
                    } else if (confirm("Are you sure you want to stop the alarm?")) {
                        clearInterval(countDown);
                        changeBackground("slow");
                        sounds.forEach(function(sound) {
                            sound.stop();
                        });
                        document.title = "Alarm";
                        S.getTag("h2")[0].innerHTML = "Seconds left: &infin;";
                        S.getId("time").value = "";
                        S.getId("time").style.display = "inline-block";
                        S.getId("start").innerHTML = "Start";
                    }
                });
                changeBackground("slow");
            });
        </script>
        <link rel="stylesheet" href="https://coolprogramminguser.github.io/Standards/formatting.css"/>
    </head>
    <body>
        <h1 class="main-title">
            Alarm
        </h1>
        <main>
            <h2>
                Seconds left: &infin;
            </h2>
            <input type="text" id="time" placeholder="Time to recur (minutes)">
            <br>
            <br>
            <button id="start">
                Start
            </button>
            <span>&nbsp;</span>
            <button id="stop">
                Stop
            </button>
        </main>
    </body>
<html>
